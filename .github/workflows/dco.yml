name: DCO

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - edited

permissions:
  contents: read
  pull-requests: read

jobs:
  dco:
    name: DCO Sign-Off Check
    runs-on: ubuntu-latest
    steps:
      - name: Verify Signed-off-by trailer on each PR commit
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const signedOffByRegex = /^Signed-off-by:\s+.+\s+<[^<>]+>$/im;
            const missing = commits.filter((commit) => {
              return !signedOffByRegex.test(commit.commit.message);
            });

            core.info(`Checked ${commits.length} commit(s).`);
            if (missing.length === 0) {
              core.info("All commits include Signed-off-by.");
              return;
            }

            for (const commit of missing) {
              core.error(`${commit.sha}: missing Signed-off-by trailer`);
            }

            core.setFailed(
              "DCO check failed. Add sign-off to each commit (for example, use 'git commit -s' or 'git rebase --signoff')."
            );
